# PixSort — 画像並び替え＆リネームツール

## 概要

ディレクトリ内のPNG画像の順番をD&Dで自由に変更し、確定時に連番（010, 020, 030...）でリネームするWindowsネイティブアプリ。手動で間に画像を挿入できるよう、10刻みの連番を採用する。

## ファイル構成

| ファイル | 説明 |
|---------|------|
| `image_sorter.py` | メインアプリ（単一ファイル） |
| `image_sorter.bat` | 起動用バッチファイル |
| `config.json` | 設定ファイル（自動生成、前回フォルダ等を保存） |
| `cache/` | サムネイルキャッシュディレクトリ（自動生成、.gitignore対象） |

## 技術スタック

- Python 3.10.11 + tkinter（GUI）
- tkinterdnd2（エクスプローラからのフォルダD&D）
- Pillow（サムネイル表示）

## UI構成

### 統合モード（デフォルト）
```
┌───────────────────────────────────────────────┐
│ [フォルダ選択]  C:\path\to\dir  [－][＋][分割]  │
├───────────────────────────────────────────────┤
│ ┌────────┐  ┌────────┐  ┌────────┐           │
│ │ thumb  │  │ thumb  │  │ thumb  │           │
│ │ 001.png│  │ 002.png│  │ 003.png│           │
│ └────────┘  └────────┘  └────────┘           │
│  ...（スクロール可能）                          │
├───────────────────────────────────────────────┤
│              [リネーム実行]                    │
└───────────────────────────────────────────────┘
```

### 分割モード
```
┌──────────────────────────────────────────────────────┐
│ [フォルダ選択]  C:\path\to\dir     [－][＋]  [統合]   │
├─────────────────────────┬─┬──────────────────────────┤
│  (Canvas左)             │ │  (Canvas右)              │
│  独立スクロール          │ │  独立スクロール           │
│  ...                    │ │  ...                     │
├─────────────────────────┴─┴──────────────────────────┤
│              [リネーム実行]                           │
└──────────────────────────────────────────────────────┘
```

- ダークグレー背景（#2b2b2b）のCanvas上にグリッド表示
- ウィンドウ幅に応じて列数が自動調整
- 初期ウィンドウサイズ: 900x700、最小: 400x300

## 機能詳細

### 1. フォルダ選択

- ボタンクリック: `tkinter.filedialog.askdirectory()` でディレクトリを選択
- フォルダD&D: エクスプローラからフォルダをウィンドウにドロップして選択（tkinterdnd2 使用）
  - パスにスペースを含む場合の `{}` ラッピングに対応
  - ディレクトリのみ受け付け（ファイルドロップは無視）
- 選択パスをヘッダーバーに表示

### 2. 画像読み込み

- 選択ディレクトリ内の `.png` ファイルをファイル名昇順でロード
- 大文字小文字を区別しない（`.PNG` も対象）
- `concurrent.futures.ThreadPoolExecutor` による並列サムネイル生成（ワーカー数: `cpu_count - 1`）
  - ワーカースレッド: PIL Image の読み込み + リサイズ + キャッシュ読み書き
  - メインスレッド: PIL → ImageTk.PhotoImage 変換（tkinter制約）、~60fps（16ms間隔）でポーリング
  - 1回のポーリングで最大10個のFutureを回収（UI応答性確保）
- 読み込み中はCanvas中央にプログレスバー（矩形描画）とパーセント表示を表示
- 読み込み中は「フォルダ選択」「リネーム実行」ボタンを無効化
- 読み込み中は「キャンセル」ボタンを表示。押すと全Futureをキャンセルし、読み込み済み画像を破棄して初期状態に戻る
- 全画像読み込み完了後にグリッドを描画
- 再読み込み時は既存のExecutorを安全にシャットダウンしてから新しいExecutorを生成

### サムネイルディスクキャッシュ

- **保存形式**: JPEG (quality=90)
- **キャッシュ場所**: `{app_dir}/cache/`（`.gitignore` で除外）
- **キャッシュキー**: `sha256(abs_path + "|" + mtime + "|" + file_size)` → ハッシュ文字列
- **ファイル名**: `{hash}_{thumb_size}.jpg`
- ソース画像の変更（mtime変化）、リネーム（パス変化）時は自動的にキャッシュミスとなり再生成
- RGBA画像はキャッシュ保存時にCanvas背景色（#2b2b2b）でRGB合成
- **自動クリーンアップ**: アプリ起動時にキャッシュ合計が200MBを超えていたら、更新日時が古い順に削除

### 3. サムネイル表示

- Pillow で 150x150 にリサイズ（アスペクト比維持）
- サムネイル下にファイル名をラベル表示（Consolas 9pt、白文字）
- セルパディング: 10px、ラベル高さ: 20px

### 4. D&D並べ替え

- Canvas上のマウスイベントで実装:
  - `<ButtonPress-1>`: ドラッグ開始、ゴースト画像生成、元画像を非表示
  - `<B1-Motion>`: ゴーストがマウスに追従、挿入位置に青いマーカー（#00bfff）を表示
  - `<ButtonRelease-1>`: ドロップ位置にアイテムを挿入、グリッド再描画
- 挿入位置の判定: セルの左半分→そのインデックスの前、右半分→次のインデックスの前

### 5. ドラッグ中の自動スクロール

- ドラッグ中にCanvas上下端から40px以内にマウスが来ると自動スクロールを開始
- スクロール速度はエッジからの距離に応じて段階的に変化（近いほど速い）
- `root.after()` で30msごとに繰り返しスクロール（ドラッグ中のみ）
- ドロップ時に自動スクロールタイマーをキャンセル

### 6. リネーム実行

- 確認ダイアログ表示後に実行
- リネーム形式: 10刻みの連番（010.png, 020.png, 030.png, ...）
- ゼロパディング桁数: 最大番号が1000未満なら3桁、以上なら桁数に合わせる
- 衝突回避: 2フェーズ方式
  1. 全ファイルを一時名（`__temp_NNNNNN.png`）にリネーム
  2. 一時名から最終連番名にリネーム
- リネーム後、表示を更新

### 7. スクロール

- マウスホイールによる縦スクロール対応
- スクロールバー表示（右端）

### 8. 前回フォルダの記憶

- 設定ファイル `config.json`（アプリと同じディレクトリ）にフォルダパスを保存
- `json` モジュールで `{"last_folder": "C:\\path\\to\\dir"}` 形式で読み書き
- フォルダを開くたびに設定ファイルを更新
- 起動時に設定ファイルから前回フォルダを読み込み、存在すれば自動で開く
- 設定ファイルが存在しない/読み込み失敗時は無視

### 9. 画像ダブルクリック拡大表示（ビューア）

- サムネイルをダブルクリックすると `tk.Toplevel` ウィンドウでフルサイズ表示
- ウィンドウサイズは画像の実サイズに合わせる（画面解像度を超える場合は画面に収まるようリサイズ、アスペクト比維持）
- 画像切り替え時もウィンドウサイズを画像に合わせて変更
- 背景は黒（#000000）
- 左右キー（←→）で前後の画像に切り替え
- Escキーまたはウィンドウ閉じるで終了
- 非モーダル（元ウィンドウの操作を抑制しない）

### 10. 左右分割ビュー

- トップバーの「分割」ボタンで左右2ペインモードに切り替え可能
- 分割モード時:
  - 左右2つのCanvas（各々独立スクロールバー付き）を表示、間に2pxの仕切り線
  - 両ペインは同じ `self.images` リストの完全なグリッドを表示
  - 各ペインは独立してスクロール可能
  - 右ペインから左ペインへ（またはその逆）のクロスキャンバスD&Dに対応
  - 挿入マーカーはマウスがいるキャンバスにのみ表示
- 統合モード時: 従来通りの単一Canvas表示
- ボタンテキストはモードに応じて「分割」⇔「統合」で切り替わる
- クロスキャンバスD&Dの実装:
  - `event.x_root` / `event.y_root`（スクリーン座標）でマウス位置のキャンバスを判定
  - キャンバス間移動時にゴースト画像を移動先キャンバスに再生成
  - 自動スクロールはアクティブキャンバス（マウスがいるキャンバス）で動作

### 11. サムネイルサイズ切り替え

- `Ctrl+マウスホイール` またはトップバーの「－」「＋」ボタンでサムネイルサイズを小(80px)・中(150px)・大(250px)の3段階で切り替え
- 読み込み時に3サイズ分を事前生成するため、切り替えは瞬時に行われる
- デフォルトは中（150px）

## 定数

| 定数 | 値 | 説明 |
|------|-----|------|
| `THUMB_SIZES` | (80, 150, 250) | サムネイルの3段階サイズ（px） |
| `THUMB_SIZE_DEFAULT_INDEX` | 1 | デフォルトのサイズインデックス（中） |
| `CELL_PADDING` | 10 | セル間のパディング（px） |
| `LABEL_HEIGHT` | 20 | ファイル名ラベルの高さ（px） |
| `AUTO_SCROLL_ZONE` | 40 | 自動スクロール発動領域（px） |
| `AUTO_SCROLL_INTERVAL` | 30 | 自動スクロールのタイマー間隔（ms） |
| `CONFIG_PATH` | (スクリプトと同ディレクトリの `config.json`) | 設定ファイルパス |
| `CACHE_DIR` | (スクリプトと同ディレクトリの `cache/`) | キャッシュディレクトリパス |
| `CACHE_MAX_BYTES` | 200 * 1024 * 1024 (200MB) | キャッシュ最大サイズ |
| `POLL_INTERVAL_MS` | 16 | Futureポーリング間隔（ms、~60fps） |
